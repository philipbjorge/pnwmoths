var urlize=function(){function k(c,a){return c.substr(0,a.length)==a}function z(c,a){return c.substr(c.length-a.length,a.length)==a}function w(d,a){var f=0,c=0;for(;;){c=d.indexOf(a,c);if(c==-1){break}f++,c+=a.length}return f}function q(a){return a.indexOf("%")==-1||a.match(C)?encodeURI(a):a}function b(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function A(c){var a;return c.length==2&&typeof c[1]=="object"?a=c[1]:a={nofollow:c[1],autoescape:c[2],trim_url_limit:c[3],target:c[4]},"django_compatible" in a||(a.django_compatible=!0),a}function E(R,U){function m(L,g){return g===undefined&&(g=U.trim_url_limit),g&&L.length>g?L.substr(0,g-3)+"...":L}U=A(arguments);var V=!1,p=U.django_compatible?B:I,r=U.django_compatible?y:j,c=U.django_compatible?J:F,n=G(R,p);for(var a=0;a<n.length;a++){var f=n[a],t=undefined;if(f.indexOf(".")!=-1||f.indexOf("@")!=-1||f.indexOf(":")!=-1){var K="",l=f,v="";for(var e=0;e<r.length;e++){var h=r[e];z(l,h)&&(l=l.substr(0,l.length-h.length),v=h+v)}for(var e=0;e<c.length;e++){var W=c[e][0],s=c[e][1];k(l,W)&&(l=l.substr(W.length),K+=W),z(l,s)&&w(l,s)==w(l,W)+1&&(l=l.substr(0,l.length-s.length),v=s+v)}var d=undefined,o=U.nofollow?' rel="nofollow"':"",u=U.target?' target="'+U.target+'"':"";l.match(D)?d=q(l):l.match(x)?d=q("http://"+l):l.indexOf(":")==-1&&l.match(H)&&(d="mailto:"+l,o="");if(d){var Q=m(l);U.autoescape&&(K=b(K),v=b(v),d=b(d),Q=b(Q)),l='<a href="'+d+'"'+o+u+">"+Q+"</a>",n[a]=K+l+v}else{V||U.autoescape&&(n[a]=b(f))}}else{V||U.autoescape&&(n[a]=b(f))}}return n.join("")}var G;G=G||function(d){var a=String.prototype.split,f=/()??/.exec("")[1]===d,c;return c=function(e,n,M){if(Object.prototype.toString.call(n)!=="[object RegExp]"){return a.call(e,n,M)}var g=[],L=(n.ignoreCase?"i":"")+(n.multiline?"m":"")+(n.extended?"x":"")+(n.sticky?"y":""),K=0,n=new RegExp(n.source,L+"g"),t,m,v,p;e+="",f||(t=new RegExp("^"+n.source+"$(?!\\s)",L)),M=M===d?-1>>>0:M>>>0;while(m=n.exec(e)){v=m.index+m[0].length;if(v>K){g.push(e.slice(K,m.index)),!f&&m.length>1&&m[0].replace(t,function(){for(var h=1;h<arguments.length-2;h++){arguments[h]===d&&(m[h]=d)}}),m.length>1&&m.index<e.length&&Array.prototype.push.apply(g,m.slice(1)),p=m[0].length,K=v;if(g.length>=M){break}}n.lastIndex===m.index&&n.lastIndex++}return K===e.length?(p||!n.test(""))&&g.push(""):g.push(e.slice(K)),g.length>M?g.slice(0,M):g},c}();var C=/%(?![0-9A-Fa-f]{2})/,y=[".",",",":",";"],j=[".",",",":",";",".)"],J=[["(",")"],["<",">"],["&lt;","&gt;"]],F=[["(",")"],["<",">"],["&lt;","&gt;"],["\u201c","\u201d"],["\u2018","\u2019"]],B=/(\s+)/,I=/([\s<>"]+)/,D=/^https?:\/\/\w/,x=/^www\.|^(?!http)\w[^@]+\.(com|edu|gov|int|mil|net|org)$/,H=/^\S+@\S+\.\S+$/;return E.test={},E.test.split=G,E.test.convert_arguments=A,E}();if(!Array.prototype.filter){Array.prototype.filter=function(b){var a=this.length>>>0;if(typeof b!="function"){throw new TypeError()}var e=[];var d=arguments[1];for(var c=0;c<a;c++){if(c in this){var f=this[c];if(b.call(d,f,c,this)){e.push(f)}}}return e}}var PNWMOTHS=PNWMOTHS||{};PNWMOTHS.Map=function(){return{initialize:function(){var a,c;a=jQuery("#googlemap");a.show();PNWMOTHS.Map.centerPoint=new google.maps.LatLng(46.9,-118);var b={scrollwheel:false,zoom:4,streetViewControl:false,center:PNWMOTHS.Map.centerPoint,mapTypeId:"terrain"};c=new google.maps.Map(a[0],b);PNWMOTHS.Map.boundary=PNWMOTHS.Map.addBoundary(c);PNWMOTHS.Map.addControls(c);PNWMOTHS.Map.counties=PNWMOTHS.Map.getCounties();PNWMOTHS.Map.openIB=new InfoBubble({map:c,disableAnimation:true,minWidth:300,disableAutoPan:false,hideCloseButton:false,arrowPosition:30,padding:12});PNWMOTHS.Map.openIB.addTab("Site","<br /><br /><br /><br /><br />");PNWMOTHS.Map.openIB.addTab("Collections","");PNWMOTHS.Map.openIB.addTab("Notes","");PNWMOTHS.Map.openIB.calcOnce=false;return c},addBoundary:function(d){var a=[new google.maps.LatLng(-87,120),new google.maps.LatLng(-87,-87),new google.maps.LatLng(-87,0)];var c=[new google.maps.LatLng(39,-126),new google.maps.LatLng(52.3,-130),new google.maps.LatLng(52.3,-109),new google.maps.LatLng(39,-109)];var b=new google.maps.Polygon({paths:[a,c],strokeColor:"#333",clickable:false,strokeOpacity:0.9,strokeWeight:2,fillColor:"#000000",fillOpacity:0.1});b.setMap(d);return b},control:function(a,e,d){a.style.marginRight="5px";a.style.marginBottom="5px";var c=document.createElement("DIV");c.style.padding="2px";c.style.backgroundColor="white";c.style.borderStyle="solid";c.style.borderWidth="1px";c.style.cursor="pointer";c.style.textAlign="center";c.title=e;a.appendChild(c);var b=document.createElement("DIV");b.style.fontFamily="Arial,sans-serif";b.style.fontSize="12px";b.style.paddingLeft="4px";b.style.paddingRight="4px";b.innerHTML="<b>"+d+"</b>";c.appendChild(b);return c},addControls:function(e){var c=document.createElement("DIV");c.index=1;jQuery(c).addClass("gmnoprint");var b=PNWMOTHS.Map.control(c,"Click to go fullscreen","Fullscreen");google.maps.event.addDomListener(b,"click",function(){var g=e.getCenter();var f=e.getBounds();window.scrollTo(0,0);setTimeout(function(){jQuery("html").toggleClass("fullscreen");jQuery("#googlemap").toggleClass("fullscreen");google.maps.event.trigger(e,"resize");var h=jQuery("#googlemap").hasClass("fullscreen");e.setCenter(g);if(h){this.children[0].innerHTML="<b>Exit Fullscreen</b>"}else{this.children[0].innerHTML="<b>Fullscreen</b>"}},100)});var d=PNWMOTHS.Map.control(c,"Click to toggle county lines","Counties");jQuery(d).toggle(function(){PNWMOTHS.Map.counties.setMap(e)},function(){PNWMOTHS.Map.counties.setMap(null)});e.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(c);var c=document.createElement("DIV");c.style.marginLeft="5px";c.index=1;jQuery(c).addClass("gmnoprint");var a=PNWMOTHS.Map.control(c,"Reset the Viewport","Reset View");google.maps.event.addDomListener(a,"click",function(){e.setZoom(4);e.setCenter(PNWMOTHS.Map.centerPoint);google.maps.event.trigger(e,"resize")});e.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(c)},getCounties:function(){return new google.maps.FusionTablesLayer({query:{select:"geometry",from:"3165511"},options:{suppressInfoWindows:true},styles:[{markerOptions:{iconName:"transparent"},polygonOptions:{fillColor:"#FFFFFF",fillOpacity:0.01,strokeColor:"#FFFFFF",strokeOpacity:0.5,strokeWeight:"2"},polylineOptions:{strokeColor:"#rrggbb",strokeWeight:"int"}}]})},htmlData:null,openMarker:function(a){PNWMOTHS.Map.handleMarkerClick(PNWMOTHS.Map.htmlData[a])()},makeMarkers:function(c,e){var a=[];if(PNWMOTHS.Map.htmlData==null){PNWMOTHS.Map.htmlData=PNWMOTHS.Map.groupMarkerData(c,e)}var d=c;for(i in d){if(d.hasOwnProperty(i)){point=new google.maps.LatLng(d[i].latitude,d[i].longitude);var b=new com.redfin.FastMarker(i,point,["<div class='marker' onclick='PNWMOTHS.Map.openMarker(\""+d[i].latitude+","+d[i].longitude+"\")'>&nbsp;</div>"],null);a.push(b)}}return(new com.redfin.FastMarkerOverlay(e,a))},renderMarkerRecord:function(g){var e={site_name:"Locality",county:"County/Regional District",state:"State/Province",elevation:"Elevation (ft.)",latitude:"Latitude",longitude:"Longitude"},m=new Array(),b=new Array(),c,a,h,l,f,d;m.push('<div id="IB_att" class="infowindow">');for(a in e){if(e.hasOwnProperty(a)){h=e[a];if(g[a]){l=g[a]}else{l=""}m.push("<p>"+h+": "+l+"</p>")}}m.push("</div>");if(g.hasOwnProperty("collections")&&g.collections.length>0){b.push('<div id="IB_col"  class="infowindow collections">');b.push("<table>");b.push("<tr><th>Date</th><th>Collector</th>");b.push("<th><a href='/dokuwiki/factsheets/collection_glossary' target='_new'>Collection</a></th>");for(f in g.collections){if(g.collections.hasOwnProperty(f)){b.push("<tr>");for(d in g.collections[f]){if(g.collections[f].hasOwnProperty(d)){var k=g.collections[f][d];if(!k){k=""}b.push("<td>"+k+"</td>")}}b.push("</tr>")}}b.push("</table>");b.push("</div>")}if(!g.notes){g.notes=""}c='<div id="IB_notes" class="infowindow collections"><p>'+urlize(g.notes,undefined,undefined,undefined,"_blank",true).replace(/\r\n/g,"<br />").replace(/\n/g,"<br />")+"</p></div>";return[m.join(""),b.join(""),c]},openIB:null,handleMarkerClick:function(a){return function(){var d=PNWMOTHS.Map.renderMarkerRecord(a);var c=PNWMOTHS.Map.openIB;var e=function(){c.removeTab(0);c.removeTab(0);c.removeTab(0);c.addTab("Site",d[0]);c.addTab("Collections",d[1]);c.addTab("Notes",d[2])};if(c.isOpen()){c.close()}e();var b=new google.maps.LatLng(a.latitude,a.longitude);c.open(PNWMOTHS.Map.map,new google.maps.Marker({position:b,clickable:false,flat:true,visible:false}));c.calcOnce=false}},groupMarkerData:function(g){var e={},d,b,c,f,h,a=["latitude","longitude","site_name","county","state","elevation","precision",];for(d in g){if(g.hasOwnProperty(d)&&g[d].latitude!=null&&g[d].longitude!=null){c=[g[d].latitude,g[d].longitude];if(typeof(e[c])==="undefined"){e[c]={}}for(b in a){f=a[b];if(e[c].hasOwnProperty(f)===false&&typeof(g[d][f])!=="undefined"){e[c][f]=g[d][f]}}if(typeof(e[c]["notes"])==="undefined"){e[c]["notes"]=""}if(g[d]["notes"]){e[c]["notes"]+=g[d]["notes"]+"\n"}if(typeof(e[c]["collections"])==="undefined"){e[c]["collections"]=[]}h=PNWMOTHS.Map.renderCollection(g[d]);if(h!==null){e[c]["collections"].push(h)}}}return e},renderCollection:function(a){var b=PNWMOTHS.Map.renderDate(a);if(!a.is_protected){var c=a.collection;if(a.collection&&a.collection__url){c='<a href="'+a.collection__url+'" target="_blank">'+a.collection+"</a>"}return[b,a.collector,c]}return null},renderDate:function(a){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var c=[];if(a.month){c.push(b[a.month-1])}if(a.day){c.push(a.day)}if(a.year){c.push(a.year)}c=c.join(" ");if(c==""){c="None"}return c}}}();PNWMOTHS.Filters=function(){var a;return{filters:{},getFilterElement:function(){return a},initialize:function(b){a=jQuery(b);return a},filterData:function(e,d){var b=e,c;b=b.filter(function(g){for(c in d){if(d.hasOwnProperty(c)){var m=g[c];var l=d[c];if(c=="elevation"){if(m==null||(m!=null&&(m<l[0]||m>l[1]))){return false}}else{if(c=="date"){if(g.year==null){return false}if(g.year!=null&&(g.year<l[0].getFullYear()||g.year>l[1].getFullYear())){return false}else{if(g.year!=null&&(g.year==l[0].getFullYear()||g.year==l[1].getFullYear())){if(g.month!=null&&(g.month<l[0].getMonth()+1||g.month>l[1].getMonth()+1)){return false}else{if(g.month!=null&&(g.month==l[0].getMonth()+1||g.month==l[1].getMonth()+1)){if(g.day!=null&&(g.day<l[0].getDate()||g.day>l[1].getDate())){return false}}}}}}else{var k=false;for(var h=0;h<l.length;h++){if(l[h]=="None (CANADA)"){l[h]=null}if((m==l[h])||(m!=null&&l[h]!=null&&(""+m).toLowerCase()==(""+l[h]).toLowerCase())){k=true}}if(!k){return false}}}}}return true});return b},MultiSelectFilter:function(d){var c=d.name;var g=d.noneSelectedText;var f=d.selectedText;var e=d.ajax;var b=function(){jQuery("#f-"+c).multiselect({noneSelectedText:g,classes:c+"-ms",selectedText:f,selectedList:10,minWidth:"auto"}).multiselectfilter();var h=function(j,k){PNWMOTHS.Filters.filters[c]=jQuery(this).multiselect("getChecked").map(function(){return this.value});if(PNWMOTHS.Filters.filters[c].length==0){delete PNWMOTHS.Filters.filters[c]}jQuery(document).trigger("requestData")};jQuery("#f-"+c).bind("multiselectclick",h);jQuery("#f-"+c).bind("multiselectcheckall",h);jQuery("#f-"+c).bind("multiselectuncheckall",h)};return{initialize:function(){if(!e){b()}return jQuery("#f-"+c)},ajaxPopulate:e,populate:function(l,m){jQuery(this).unbind(l);var h=jQuery("#f-"+c),k,j;for(j in m){if(m.hasOwnProperty(j)){k=jQuery("<option></option>");k.val(m[j]);k.text(m[j]);h.append(k)}}b();return h},reset:function(h){if(jQuery("#f-"+c).multiselect("getChecked").length){jQuery("#f-"+c).multiselect("uncheckAll")}}}},DateRangeFilter:function(e){var c=e.name;c="date";var d=e.bounds;var f=e.ajax;var b=function(g){jQuery("#f-"+c).dateRangeSlider({defaultValues:g,bounds:g,arrows:false});jQuery("#f-"+c).bind("valuesChanged",function(h,k){PNWMOTHS.Filters.filters[c]=[k.values.min,k.values.max];var j=new Date(g.min);j.setDate(j.getDate()+1);var l=new Date(g.max);l.setDate(l.getDate()-1);if(k.values.min<j&&k.values.max>l){delete PNWMOTHS.Filters.filters[c]}jQuery(document).trigger("requestData")})};return{initialize:function(){if(!f){b(d)}return jQuery("#f-"+c)},ajaxPopulate:f,populate:function(g,h){jQuery(this).unbind(g);b({min:new Date(Date.parse(h.dates__min)),max:new Date(Date.parse(h.dates__max))})},reset:function(j){var h=jQuery("#f-"+c);var g=h.dateRangeSlider("bounds");h.dateRangeSlider("values",g.min,g.max);if(j){delete PNWMOTHS.Filters.filters[c]}}}},EditRangeFilter:function(e){var c=e.name;c="elevation";var d=e.bounds;var f=e.ajax;var b=function(g){jQuery("#f-"+c).editRangeSlider({defaultValues:g,bounds:g,arrows:false});jQuery("#f-"+c).bind("valuesChanged",function(h,j){PNWMOTHS.Filters.filters[c]=[j.values.min,j.values.max];if(j.values.min<g.min+1&&j.values.max>g.max-1){delete PNWMOTHS.Filters.filters[c]}jQuery(document).trigger("requestData")})};return{initialize:function(){if(!f){b()}return jQuery("#f-"+c)},ajaxPopulate:f,populate:function(g,h){jQuery(this).unbind(g);b({min:h.elevation__min,max:h.elevation__max})},reset:function(j){var h=jQuery("#f-"+c);var g=h.editRangeSlider("bounds");h.editRangeSlider("values",g.min,g.max);if(j){delete PNWMOTHS.Filters.filters[c]}}}}}}();jQuery(document).unload(function(){if(typeof(GUnload)!="undefined"){GUnload()}});jQuery(document).ready(function(){if(jQuery("#googlemap .data").length!=0){var c=jQuery.parseJSON(jQuery("#googlemap .data").text());if(typeof(c)!="string"){c=c[0]}var a="#"+c;jQuery(a).bind("dataIsReady",function(d,e){if(typeof PNWMOTHS.Map.map==="undefined"){PNWMOTHS.Map.map=PNWMOTHS.Map.initialize();google.maps.event.addListenerOnce(PNWMOTHS.Map.map,"idle",function(){google.maps.event.trigger(PNWMOTHS.Map.map,"resize");PNWMOTHS.Map.markers=PNWMOTHS.Map.makeMarkers(e,PNWMOTHS.Map.map)})}else{PNWMOTHS.Map.openIB.close();PNWMOTHS.Map.markers.setMap(null);delete PNWMOTHS.Map.markers;PNWMOTHS.Map.markers=PNWMOTHS.Map.makeMarkers(e,PNWMOTHS.Map.map)}});PNWMOTHS.Filters.initialize("#filters");filters=[{name:"county",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Counties/Regional Districts",selectedText:"Filtering on # counties",ajax:true},{name:"state",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"States/Provinces",selectedText:"Filtering on # states",ajax:true},{name:"collection",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Collections",selectedText:"Filtering on # collections",ajax:true},{name:"record_type",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Voucher Types",selectedText:"Filtering on # types",ajax:true},{name:"range",type:PNWMOTHS.Filters.DateRangeFilter,ajax:true},{name:"year",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Years",selectedText:"Filtering on # years",ajax:true},{name:"month",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Months",selectedText:"Filtering on # months",ajax:true},{name:"day",type:PNWMOTHS.Filters.MultiSelectFilter,noneSelectedText:"Days",selectedText:"Filtering on # days",ajax:true},{name:"range",type:PNWMOTHS.Filters.EditRangeFilter,ajax:true}];var b=[];jQuery.each(filters,function(d,f){var e=new f.type(f);b.push(e);e.initialize();if(e.ajaxPopulate){jQuery("#"+f.name+"-data").bind("dataIsReady",e.populate)}});jQuery("#f-reset").click(function(){jQuery.each(b,function(d,e){e.reset(false)});PNWMOTHS.Filters.filters=[];jQuery(document).trigger("requestData")});jQuery(document).bind("requestData",function(d){jQuery(a).trigger("dataIsReady",[PNWMOTHS.Filters.filterData(PNWMOTHS.Data.data[c],PNWMOTHS.Filters.filters)])})}});