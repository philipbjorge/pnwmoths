(function(b){var c=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;b.widget("ech.multiselectfilter",{options:{label:"Filter:",width:null,placeholder:"Enter keywords",autoReset:!1},_create:function(){var f;var a=this,h=this.options,g=this.instance=b(this.element).data("multiselect");this.header=g.menu.find(".ui-multiselect-header").addClass("ui-multiselect-hasfilter");f=this.wrapper=b('<div class="ui-multiselect-filter">'+(h.label.length?h.label:"")+'<input placeholder="'+h.placeholder+'" type="search"'+(/\d/.test(h.width)?'style="width:'+h.width+'px"':"")+" /></div>").prependTo(this.header),h=f;this.inputs=g.menu.find('input[type="checkbox"], input[type="radio"]');this.input=h.find("input").bind({keydown:function(d){13===d.which&&d.preventDefault()},keyup:b.proxy(a._handler,a),click:b.proxy(a._handler,a)});this.updateCache();g._toggleChecked=function(o,n){var m=n&&n.length?n:this.labels.find("input"),l=this,m=m.not(a.instance._isOpen?":disabled, :hidden":":disabled").each(this._toggleState("checked",o));this.update();var k=m.map(function(){return this.value}).get();this.element.find("option").filter(function(){!this.disabled&&-1<b.inArray(this.value,k)&&l._toggleState("selected",o).call(this)})};g=b(document).bind("multiselectrefresh",function(){a.updateCache();a._handler()});this.options.autoReset&&g.bind("multiselectclose",b.proxy(this._reset,this))},_handler:function(a){var l=b.trim(this.input[0].value.toLowerCase()),k=this.rows,i=this.inputs,f=this.cache;if(l){k.hide();var j=RegExp(l.replace(c,"\\$&"),"gi");this._trigger("filter",a,b.map(f,function(e,d){return -1!==e.search(j)?(k.eq(d).show(),i.get(d)):null}))}else{k.show()}this.instance.menu.find(".ui-multiselect-optgroup-label").each(function(){var d=b(this),e=d.nextUntil(".ui-multiselect-optgroup-label").filter(function(){return"none"!==b.css(this,"display")}).length;d[e?"show":"hide"]()})},_reset:function(){this.input.val("").trigger("keyup")},updateCache:function(){this.rows=this.instance.menu.find(".ui-multiselect-checkboxes li:not(.ui-multiselect-optgroup-label)");this.cache=this.element.children().map(function(){var a=b(this);"optgroup"===this.tagName.toLowerCase()&&(a=a.children());return a.map(function(){return this.innerHTML.toLowerCase()}).get()}).get()},widget:function(){return this.wrapper},destroy:function(){b.Widget.prototype.destroy.call(this);this.input.val("").trigger("keyup");this.wrapper.remove()}})})(jQuery);